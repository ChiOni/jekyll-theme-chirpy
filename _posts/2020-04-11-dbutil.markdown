---
title: Databricks Utilities (Databricks)
date: 2020-04-11 00:00:00 +0800
categories: [Tips for Working, Databricks]
tags: [dbutil,databricks]
seo:
  date_modified: 2020-04-11 20:07:02 +0800

---

<img src="/assets/img/wt/dbutil/dbutilone.jpg">  

회사에 와서 낯설게 느껴졌던 것 중 하나는 업무의 많은 부분이 Databricks라는 환경에서 이루어진다는 것이었다. 사실 반년을 넘게 사용했지만 아직도 기능 많고 효율적이고 공유 가능한 쥬피터 노트북 정도로 느껴질 때가 많다. 사실 Databricks가 워낙 거대한 플랫폼이고 너무너무  많은 기능을 제공해주기 때문에, **Databricks란 무엇인가?**와 같은 뜬구름 잡는 포스트는 쓰고 싶지 않다.  업무를 하다가 가끔 아오 왜 이런게 안되지? 우와 이렇게 하면 되네? 와 같은 것들을 하나하나 꿀팁마냥 기록해나가보려고 한다.

< img src="/assets/img/wt/dbutil/dbutilthree.jpg">

위키피디아에 그냥 써있는 대로 보자면, Databricks는 아파치 스파크 프로젝트 중 일부이며, Scala 언어로 만들어진 오픈 소스 분산 컴퓨팅 프레임워크이다. 홈페이지 메인의 설명을 보면 데이터의 수집부터 처리 분석부터 모델까지, 데이터를 활용한 모든 파이프라인을 관리할 수 있는 플랫폼이라 보면 되는 것 같다. 

<img src="/assets/img/wt/dbutil/dbutilfour.jpg">

모든 구조와 요소들을 모두 이해할 필요는 없겠지.  나의 역할은 잘 가공해주신 데이터를  의미있게 활용하는 것이다. 클라우드가 뭔지 잘 몰라서 이렇게 말해도 되는지 잘 모르겠지만, 내가 속해있는 데이터 브릭스의 클라우드 환경에는 각자의 업무 공간이 존재한다. 권한만 주어진다면 서로의 코드를 재사용하는 것도, 수정하는 것도, 실행하는 것도 모두 자유롭게 가능하다. <b> ./home/치오니 폴더/치오니 노트북</b> 이라는 경로에 어떤 파이썬 함수를 내가 만들어놓으면 누구나 자신의 공간에서 이 함수를 사용하는 것이 가능하다.

<img src="/assets/img/wt/dbutil/dbutilfive.jpg">

각 노트북에는 두 가지 선택해줄 부분이 있는데, 하나는 (1)어떤 언어를 기반으로한 노트북을 생성할 것인지와 (2)어떤 클러스터의 리소스를 사용할 것인지이다. 공부해보고 싶은 것 중 하나가 클러스터의 리소스와 용량에 관한 것들인데 그건 나중에 보기로 하고 노트북을 어떻게 사용하는지를 살펴보자.

<img src="/assets/img/wt/dbutil/dbutilsix.jpg">

기반 언어를 python 으로 설정했다고 하여 다른 언어를 사용하지 못하는 것은 아니다. <b>%사용하려는 언어</b>를 놓고 해당 문법을 사용해서 셀을 실행하는 것은 아니다. 그리고 %를 사용하여 %md (마크다운) %sh (쉘)의 명령어를 내리는 것도 가능하다. %sh pip install torch 등과 같은 코드를 사용하여 클러스터에 등록되어 있지 않던 라이브러리를 임포트하는 것도 할 수 있다. 

<img src="/assets/img/wt/dbutil/dbutilseven.jpg">

그러나 상상한것 보다 이런 노트북 환경이 유용하지 않은 경우가 많았다. 위의 이미지와 같이 다른 언어를 사용하여 파이썬으로 할당해놓은 변수를 사용하는 것도, 할당된 변수를 덮어쓰기 하는 것도 불가능하기 때문이다. 이런 환경은 dplyr을 사용하여 테이블을 가공하고 sklearn으로 모델링을 수행한 후 ggplot으로 시각화를 하고 싶은 니즈가 있을 때 엄청나게 귀찮아진다. 그나마 이런 작업을 수월하게 할 수 있도록 Databricks에서 제공하고 있는 기능이 <b>dbutils</b> 클래스의 함수들이다. 

<img src="/assets/img/wt/dbutil/dbutileight.jpg">

여러 태스크를 유연하게 연결하고 데이터베이스를 효율적으로 관리하고 파라미터나 시크릿 키 등을 재사용하기 위한 기능이라고 한다. dbutil은 용도에 따라 5가지로 구분할 수 있다.

- File system utilities

  - Databricks File System(DBFS)에 접근하고 조회하기 주로 사용

- **Notebook workflow utilities** 

  - 여러 노트북의 작업들을 run & exit method를 활용하여 연결된 체인처럼 사용
  - run에는 path / timeout / argument를 넣을 수 있다.
  - timeout을 통해 시간안에 완료되지 않았을 때의 exception 수행
  - 해당 노트북에서 사용하는 값들을 argument에 key-value 형태로 집어넣을 수 있다.
  - exit를 통해서는 teomporary view 생성 / dbfs에 데이터 쓰기 / json 리턴 등이 가능하다.
  - 아래서 자세히 봐보자.

- Widget utilities

  - 반응형의 widget을 생성하여 자주 사용하는 변수들을 여러 언어의 cell에서 재사용할 수 있다.

  - <b>getArgumen(변수 명)</b>을 통해 할당해놓은 값들을 다시 사용해준다.

    <img src="/assets/img/wt/dbutil/dbutileight.jpg" width = "100" height = "250">

    <center><small>상단에 위젯이 등장하고 여러 언어의 셀에서 사용한다</small></center> 

- Secrets utilities

  - 비밀로 해야할 변수들은 jdbc에 저장해놓고 dbutils.secreat.get()으로 가져와 주자

- Library utilities

  - %sh pip install torch 와 같이 셀을 shell로 바꾸고 명령을 수행해줘도 되지만

    dbutils.library.installPyPI("torch")의 형태로 라이브러리를 받을 수도 있다.

<br/>

dbutils에 어떤 기능들이 있는지 가볍게 살펴봤으니, 원래의 취지에 맞게 여러 언어간에 교환하며 작업하기!를 수행해보자. 사용 언어는 R과 Python이며 사용하게 될 dbutils의 클래스는 <b>dbutils.notebook</b>이다.

<br/>

 



